<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="../../../style/common/reset.css">
    <link rel="stylesheet" type="text/css" href="../../../libs/easyui/themes/gray/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../../libs/easyui/themes/color.css"/>
    <link rel="stylesheet" type="text/css" href="../../../libs/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../../libs/easyui/themes/kno-icon-expends.css">
    <!-- <link rel="stylesheet" type="text/css" href="../../../libs/easyui/themes/kno-gray/kno-easyui.css">-->
    <link rel="stylesheet" type="text/css" href="../../../style/common/commonIcon.css">
    <link rel="stylesheet" type="text/css" href="../../../style/index.css">

    <script type="text/javascript" src="../../../libs/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../../libs/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../../libs/knowind/CFactory.js"></script>
    <script type="text/javascript" src="../../../js/common/config.js"></script>
    <script type="text/javascript" src="../../../libs/knowind/uuid.js"></script>
    <style>
        .span_style {
            width: 90px;
            display: inline-block;
            text-align: right;
        }

        .span_input {
            width: 140px;
            height: 22px;
            line-height: 22px;
        }

        .span_select {
            width: 144px;
            height: 26px;
            line-height: 26px;
        }

        .span_li {
            float: left;
            width: 300px;
            margin: 18px auto 0 auto;
        }

        .span_div {
            margin: 18px auto 0 auto;
        }

        .span_div input {
            width: 440px;
        }

        .span_div select {
            width: 444px;
        }

        /*树表格样式*/
        .datagrid-header, .datagrid-toolbar, .datagrid-pager, .datagrid-footer-inner {
            border-color: #fff;
        }

        .datagrid-header, .datagrid-td-rownumber {
            background-color: #fff;
            background: #fff;
            background: #fff;
            background: #fff;
            background: #fff;
            background-repeat: repeat;
            background-repeat: repeat-x;
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr=#fdfdfd, endColorstr=#f5f5f5, GradientType=0);
        }

        .datagrid-header td, .datagrid-body td, .datagrid-footer td {
            border-color: #fff;
        }

        .tree-title {
            font-size: 12px;
            color: #333;
            margin: 0;
        }

        .datagrid-cell, .datagrid-cell-group, .datagrid-header-rownumber, .datagrid-cell-rownumber {
            font-size: 12px;
            color: #999;
        }

        .datagrid-cell span {
            color: #333;
        }

        .mybtn {
            background: url("../../../imgs/add.png") 0 0 no-repeat;
            width: 80px;
            height: 80px;
            border: 0;
        }

        .mybtn:hover {
            background-color: rgb(91, 160, 91);
            border-color: rgb(91, 160, 91);
            color: white;
            text-decoration: none;
        }

        .myinp {
            width: 100px;
            height: 30px;
            display: inline-block;
            border: 1px solid rgb(209, 232, 250);
            border-radius: 2px;
        }

        #div4bm {
            padding-top: 15px;
            margin-right: 15px;
        }

        #mybutton {
            margin-left: 100px;
        }

        #myimg {
            width: 164px;
            height: 164px;
        }
    </style>
</head>
<body>
<div compName="packBageProComponent" style="width: 100%;height: 100%;background-color: #eaeef4;">
    <div class="easyui-layout" style="width:100%;height:100%;border: 0;">
        <div data-options="region:'north'"
             style="height:30px;border: 0;border-bottom: solid #c6cfdb 1px;background-color: #005f92;">
            <ul style="text-align: right;height: 100%;-webkit-app-region:drag;">
                <li style="float: right;width: 22px;height: 22px;cursor: pointer; -webkit-app-region:no-drag;"
                    onmouseover="packBageProComponent.showMouseOverState(this,'../../../imgs/common/commonIcon_close')"
                    onmouseout="packBageProComponent.hideMouseOverState(this,'../../../imgs/common/commonIcon_close')">
                    <img class="fa-close" n-ui-command="close" src="../../../imgs/common/commonIcon_close.png"></li>
                <li style="float: right;width: 22px;height: 22px;cursor: pointer;-webkit-app-region:no-drag;"
                    onmouseover="packBageProComponent.showMouseOverState(this,'../../../imgs/common/commonIcon_minimize')"
                    onmouseout="packBageProComponent.hideMouseOverState(this,'../../../imgs/common/commonIcon_minimize')">
                    <img class="fa-window-minimize" n-ui-command="minimize"
                         src="../../../imgs/common/commonIcon_minimize.png"></li>
            </ul>
        </div>
        <div data-options="region:'center'" style="border: 0;background-color: #eaeef4;padding: 20px 20px;">
            <!--选择程序包-->
            <div knocomp="checkPackagePage">
                <div>
                    <span>选择程序包&nbsp;&nbsp;&nbsp;&nbsp;</span><input knocomp="packBagePro" type="text" readonly
                                                                     style="height: 22px;line-height: 22px;padding: 0 10px;width:420px; ">
                    <a href="#" class="easyui-linkbutton" data-options="iconCls:'kno_icon_publish'"
                       style="padding:0 5px;height: 24px;" onclick="packBageProComponent.checkPublishProgram()">
                        <span style="font-size: 12px;">选择</span>
                    </a>
                </div>
                <div style="margin-top: 30px;">
                    <button style="display: inline-block;padding: 5px 18px;border: solid #797979 1px;border-bottom: 0;background-color: #fff;" onclick="alert('程序包解析显示')">程序包解析显示</button>
                    <button style="display: inline-block;padding: 5px 18px;border: solid #797979 1px;border-bottom: 0;background-color: #fff;" onclick="alert('程序参数')">程序参数</button>
                    <div style="background-color: #fff;height: 270px;overflow: auto;">
                        <table knocomp="packkageTree" class="easyui-treegrid"
                               data-options="fit:true,fitColumns:true,treeField: 'name',idField:'name'">
                        </table>
                    </div>
                    <div style="line-height: 38px;height: 38px;color: red" knocomp="packageTipCon"></div>
                </div>
                <div style="margin-top: 10px;">
                    <a href="#" class="easyui-linkbutton" knocomp="packageNextBtn"
                       style="padding:0 5px;height: 24px;float: right;" onclick="packBageProComponent.packageNext()">
                        <span style="font-size: 12px;">下一步</span>
                    </a>
                </div>
            </div>
            <!--填写程序基本信息-->
            <div knocomp="setPackageXmlDesPage" style="display: none;padding: 0 50px;">
                <div>
                    <img src="../../../imgs/common/defaultProgram.png"
                         style="width: 30px;height: 30px;display: inline-block;">
                    <span style="vertical-align: top;font-weight: 700;margin-left: 10px;font-weight: 14px;"
                          knocomp="appNameCon"></span>
                </div>
                <div>
                    <ul style="overflow: hidden;">
                        <li class="span_li">
                            <label><span
                                    class="span_style">功能分类：</span><select class="span_select"
                                                                           knocomp="applicationTypeCon">
                            </select></label>
                        </li>
                        <li class="span_li">
                            <label><span
                                    class="span_style">原理依据：</span><select class="span_select"
                                                                           knocomp="principleTypeCon">
                            </select></label>
                        </li>
                        <li class="span_li">
                            <label><span class="span_style">版本：</span><input type="text" class="span_input"
                                                                             knocomp="fmiVersionCon"></label>
                        </li>
                        <li class="span_li">
                            <label><span class="span_style">作者：</span><input type="text" class="span_input"
                                                                             knocomp="authorCon"></label>
                        </li>
                        <li class="span_li">
                            <label><span class="span_style">专业：</span><select class="span_select" knocomp="categoryCon">
                            </select></label>
                        </li>
                        <li class="span_li">
                            <label><span
                                    class="span_style">程序开发语言：</span><select class="span_select"
                                                                             knocomp="generationToolCon">
                            </select></label>
                        </li>
                        <li class="span_li">
                            <label><span
                                    class="span_style">程序类型：</span><select class="span_select" knocomp="programTypeCon">
                            </select></label>
                        </li>
                    </ul>
                    <div class="span_div">
                        <label><span class="span_style">关键词：</span><input type="text" class="span_input"
                                                                          knocomp="keywordCon"></label>
                    </div>
                    <div class="span_div">
                        <label><span class="span_style">程序分类：</span><select class="span_select"
                                                                            knocomp="moduleCategoryCon">
                        </select></label>
                    </div>
                    <div style="line-height: 38px;height: 38px;color: red"></div>
                </div>
                <div style="margin-top: 2px;">
                    <!--    <a href="#" class="easyui-linkbutton" knocomp="packagePublishBtn"
                           style="padding:0 5px;height: 24px;float: right;"
                           onclick="packBageProComponent.publishProgramToLocal()">
                            <span style="font-size: 12px;">发布程序</span>
                        </a>-->
                    <a href="#" class="easyui-linkbutton" knocomp="openProFunDesBtn"
                       style="padding:0 5px;height: 24px;float: right;"
                       onclick="packBageProComponent.openProFunDes()">
                        <span style="font-size: 12px;">下一步</span>
                    </a>
                    <a href="#" class="easyui-linkbutton" knocomp="packageBackBtn"
                       style="padding:0 5px;height: 24px;float: right;"
                       onclick="packBageProComponent.packageBack()">
                        <span style="font-size: 12px;">上一步</span>
                    </a>
                </div>
            </div>
            <!--填写程序简介信息-->
            <div knocomp="setProDesDialog" style="display: none;padding: 0 50px;">
                <div>
                    <img src="../../../imgs/common/defaultProgram.png"
                         style="width: 30px;height: 30px;display: inline-block;">
                    <span style="vertical-align: top;font-weight: 700;margin-left: 10px;font-size: 12px;line-height: 26px;"
                          knocomp="setProDesNameCon"></span>
                    <div style="padding:15px 0 5px 0;">
                        <h6 style="font-size: 12px;line-height: 22px;margin-bottom: 5px;color: #333;"><img
                                src="../../../imgs/Abstract/appInt.png"
                                width="14px"
                                height="14px">&nbsp;&nbsp;程序介绍</h6>
                        <div>
                            <span style="vertical-align: top;display: inline-block;width: 80px;text-align: left;color: #666;">程序介绍：</span>
                            <textarea rows="3" cols="80" class="signAppInitProject"
                                      style="padding: 5px 10px;color: #666;border: solid #ACA7A2 1px;"></textarea>
                        </div>
                    </div>
                    <div style="padding: 15px 0 5px 0;">
                        <h6 style="font-size: 12px;line-height: 22px;margin-bottom: 5px;"><img
                                src="../../../imgs/Abstract/appFun.png" style="vertical-align: text-top;"
                                width="16px"
                                height="16px">&nbsp;&nbsp;功能特点</h6>
                        <div id="appIntCon">
                            <div>
                                <span style="vertical-align: top;display: inline-block;width: 80px;text-align: left;color: #666;">特点：</span>
                                <textarea rows="1" cols="80"
                                          style="padding: 5px 10px;color: #666;border: solid #ACA7A2 1px;"
                                          class="signAppFunText"></textarea>
                            </div>

                            <!--  <div>
                                  <span style="vertical-align: top;display: inline-block;width: 80px;text-align: left;float: left;color: #666;">特点：</span>
                                  <div style="margin-left: 81px;">
                                      <div>
                                          <span style="vertical-align: top;display: inline-block;width: 40px;text-align: left;color: #666;">标题：</span>
                                          <input type="text" style="width: 81%;border: solid #ACA7A2 1px;padding: 5px 10px;"
                                                 class="signAppFunTitle">
                                      </div>
                                      <div style="margin-top: 8px;">
                                          <span style="vertical-align: top;display: inline-block;width: 40px;text-align: left;color: #666;">内容：</span>
                                          <textarea rows="5" cols="73"
                                                    style="padding: 5px 10px;color: #666;border: solid #ACA7A2 1px;"
                                                    class="signAppFunText"></textarea>
                                      </div>
                                  </div>
                              </div>-->
                        </div>
                        <div style="text-align: center;padding: 6px 0">
                            <a href="#" class="easyui-linkbutton" knocomp="appIntroduceAddFunBtn"
                               style="padding:0 5px;height: 22px;"
                               onclick="packBageProComponent.appIntroduceAddFun()">
                                <span style="font-size: 12px;">添加功能特点</span>
                            </a>
                        </div>
                        <div style="padding: 0 0;">
                            <div id='appFunAddImgsCon'>
                                <img id="appFunAddImgBtn"
                                     src="../../../imgs/add.png"
                                     style="width: 80px;height: 80px;vertical-align: top;margin-top: 10px; margin-left: 8px;"
                                     onclick="document.getElementById('appFunAddInput').click();">
                                <input type="file" name="file" accept="image/png,image/jpg,image/jpeg"
                                       id="appFunAddInput"
                                       onchange="packBageProComponent.addAppFunImgs(this,'appFunAddInput','appFunAddImgBtn')"
                                       style="display:none;"/>

                            </div>
                        </div>
                        <!--    <div style="padding: 30px 0 5px 0;">
                                <h6 style="font-size: 12px;line-height: 22px;margin-bottom: 15px;"><img
                                        src="../../../imgs/Abstract/appModule.png"
                                        width="18px"
                                        height="18px">&nbsp;&nbsp;具体模块说明</h6>
                                <div id="appIntModuleCon">
                                    <div>
                                    <span style="vertical-align: top;display: inline-block;width: 120px;text-align: left;float: left;color: #666;">

                                        <img id="module001Con" class="signAppModuleImg"
                                             src="../../../imgs/add.png" style="width: 80px;height: 80px;"
                                             onclick="document.getElementById('module001').click();">
                                        <input type="file" name="file" accept="image/png,image/jpg,image/jpeg"
                                               id="module001"
                                               onchange="packBageProComponent.appIntroduceAddFunImg(this,'module001','module001Con');"
                                               style="display:none;"/>


                                    </span>
                                        <div style="margin-left: 121px;">
                                            <div>
                                                <span style="vertical-align: top;display: inline-block;width: 40px;text-align: left;color: #666;">标题：</span>
                                                <input type="text"
                                                       style="width: 87%;border: solid #ACA7A2 1px;padding: 5px 10px;"
                                                       class="signAppModuleTitle">
                                            </div>
                                            <div style="margin-top: 8px;">
                                                <span style="vertical-align: top;display: inline-block;width: 40px;text-align: left;color: #666;">内容：</span>
                                                <textarea rows="5" cols="73"
                                                          style="padding: 5px 10px;color: #666;border: solid #ACA7A2 1px;"
                                                          class="signAppModuleText"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center;padding: 10px 0">
                                    <a href="#" class="easyui-linkbutton" knocomp="appIntroduceAddModuleDesBtn"
                                       style="padding:0 5px;height: 24px;"
                                       onclick="packBageProComponent.appIntroduceAddModuleDes()">
                                        <span style="font-size: 12px;">添加模块说明</span>
                                    </a>
                                </div>
                            </div>-->
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="#" class="easyui-linkbutton" knocomp="packagePublishBtn"
                           style="padding:0 5px;height: 24px;float: right;"
                           onclick="packBageProComponent.ceatePreviewHtmlStr()">
                            <span style="font-size: 12px;">发布程序</span>
                        </a>
                        <a href="#" class="easyui-linkbutton" knocomp="setProDesBackBtn"
                           style="padding:0 5px;height: 24px;float: right;"
                           onclick="packBageProComponent.setProDesBack()">
                            <span style="font-size: 12px;">上一步</span>
                        </a>
                    </div>
                </div>
                <div id="htmlStrDiv" style="display: none"><!DOCTYPE html>
                    <html lang="en" style="padding: auto 40px;">
                    <head>
                        <meta charset="UTF-8">
                        <title>Title</title>
                        <script type="text/javascript" src="Abstract/jquery.min.js"></script>
                        <script type="text/javascript" src="Abstract/CFactory.js"></script>
                        <style>
                            * {
                                font-family: 微软雅黑;
                                margin: 0;
                            }
                            html,body{
                                height: 98%;
                                width: 100%;
                                background-color: #EAEEF4;
                            }
                        </style>
                    </head>
                    <body style="background-color: #EAEEF4;">
                    <div id="appIntCon1" style="padding: 0 8px;">
                        <h2 style="font-size: 12px;color: #005f92;line-height: 22px;margin-top: 20px;"><img
                                id="appIntCon1Img" class="signImgTransBase"
                                src="../../../imgs/Abstract/appInt.png"
                                width="14px"
                                height="14px">&nbsp;&nbsp;程序介绍
                        </h2>
                    </div>
                    <div id="appFunCon" style="padding: 0 8px;">
                        <h2 style="font-size: 12px;color: #005f92;line-height: 22px;margin-top: 20px;"><img
                                id="appFunConImg" class="signImgTransBase"
                                src="../../../imgs/Abstract/appFun.png" style="vertical-align: text-bottom;"
                                width="16px"
                                height="16px">&nbsp;&nbsp;功能特点
                        </h2>
                    </div>
                    <script type="text/javascript">
                        function initHtmlDes(data) {
                            var node = CFactory.createNode({
                                type: "p",
                                attr: {
                                    style: "color:#333;font-size:12px;padding-left:24px"
                                },
                                text: data.appInt.appIntroduce
                            });
                            $("#appIntCon1").append(node);


                            for (var i = 0; i < data.appFun.funArry.length; i++) {
                                var funNode = CFactory.createNode({
                                    type: "div",
                                    attr: {
                                        style: "margin-top: 10px;"
                                    },
                                    child: [ {
                                        type: "p",
                                        attr: {
                                            style: "color:#333;font-size:12px;padding-left:24px"
                                        },
                                        text: data.appFun.funArry[i].content
                                    }]
                                });
                                $("#appFunCon").append(funNode);
                            }


                            for (var i = 0; i < data.appFun.imgs.length; i++) {
                                var funImgNode = CFactory.createNode({
                                    type: "div",
                                    attr: {
                                        style: "display: inline-block;width:410px;height:260px;vertical-align: top;margin-left:24px;margin-top:10px;overflow: hidden;"
                                    },
                                    child:[
                                        {
                                            type: "img",
                                            attr: {
                                                style: "width:100%;",
                                                src: data.appFun.imgs[i].src
                                            }
                                        }
                                    ]
                                });
                                $("#appFunCon").append(funImgNode);
                            }


                        }

                    </script>
                    </body>
                    </html>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        window.htmlStrData = {};
        var packBageProComponent = CFactory.createComponent({
            compName: "packBageProComponent",
            //小程序包数据
            packBageResult: {},
            imgBase64: "",
            init: function () {

            },
            //选择项目包结构
            checkPublishProgram: function () {
                var result = Kworld.IoOption.choosePackage();
                if (result) {
                    $(this.packageTipCon).text("");
                    var result_ = JSON.parse(result);
                    this.packBageResult = result_;
                    if (result_.data.path) {
                        $(this.packBagePro).val(result_.data.path);
                    }
                    if (result_.data.package) {
                        $(this.packkageTree).treegrid({
                            columns: [[
                                {
                                    field: 'name', title: '名称', width: "320", align: "left"
                                },
                                {
                                    field: 'updateDate', title: '修改日期', width: "200", align: "left"
                                },
                                {
                                    field: 'size',
                                    title: '大小',
                                    width: "100",
                                    align: "left",
                                    formatter: function (value, row, index) {
                                        var size_ = Math.round(value / 1024);
                                        return size_ + "KB";
                                    }
                                }
                            ]],
                            data: result_.data.package
                        });
                        $(".datagrid-row").css({"height": "22px"})
                    }
                    if ("success" == result_.state) {
                        $(this.packageNextBtn).linkbutton('enable');
                    } else {
                        $(this.packageTipCon).text(result_.msg);
                        $(this.packageNextBtn).linkbutton('disable');
                    }
                } else {
                    $(this.packageNextBtn).linkbutton('disable');
                }
            },
            //设置程序关闭、最小化等等按钮样式
            showMouseOverState: function (ele, src) {
                $(ele).children("img").attr("src", src + "_hover.png");
            },
            hideMouseOverState: function (ele, src) {
                $(ele).children("img").attr("src", src + ".png");
            },
            addAppFunImgs: function (ele, id, appFunAddImgsCon) {
                var filePath = $(ele).val();
                var fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase(),
                    fileObj = document.getElementById(id).files[0];
                if (!fileFormat.match(/.png|.jpg|.jpeg/)) {
                    alert('上传错误,文件格式必须为：png/jpg/jpeg');
                    return;
                }
                this.compress(fileObj, function (imgBase64) {
                    this.imgBase64 = imgBase64; //存储转换的base64编码alert(imgBase64)
                    var uuid = Math.uuid();
                    var nodeImg = CFactory.createNode({
                        type: "div",
                        attr: {
                            style: "position: relative;display: inline-block;width:80px;height:80px;overflow: hidden;",
                            id: uuid + "div"
                        },
                        child: [{
                            type: "img",
                            attr: {
                                width: "100%",
                                style: "",
                                src: imgBase64,
                                style: "margin:10px 5px",
                                class: "signAppFunImgs",
                                id: uuid
                            },
                            events: {
                                /*  onmouseover:function (e) {
                                 e.stopPropagation();
                                 var uuid=$(this).attr("id");
                                 $("#"+uuid+"i").css({"display":"inline-block"})
                                 },
                                 onmouseout:function (e) {
                                 e.stopPropagation();
                                 var uuid=$(this).attr("id");
                                 $("#"+uuid+"i").css({"display":"none"})
                                 }*/
                            }
                        }, {
                            type: "img",
                            attr: {
                                style: "position: absolute;right:5px;top:10px;width:18px;height:18px;cursor: pointer;",
                                src: "../../../imgs/common/del.png",
                                id: uuid + "i",
                                uuid: uuid
                            },
                            events: {
                                onclick: function () {
                                    var uuid = $(this).attr("uuid");
                                    $("#" + uuid + "div").remove();
                                }
                            }
                        }]
                    });
                    $('#' + appFunAddImgsCon).before(nodeImg); //显示预览图片
                });
            },
            //功能特点选择图片
            appIntroduceAddFunImg: function (ele, id, imgcon) {
                var filePath = $(ele).val();
                var fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase(),
                    fileObj = document.getElementById(id).files[0];
                if (!fileFormat.match(/.png|.jpg|.jpeg/)) {
                    alert('上传错误,文件格式必须为：png/jpg/jpeg');
                    return;
                }
                this.compress(fileObj, function (imgBase64) {
                    this.imgBase64 = imgBase64; //存储转换的base64编码alert(imgBase64)
                    $('#' + imgcon).attr('src', imgBase64); //显示预览图片
                });
            },
            compress: function (fileObj, callback) {
                this.directTurnIntoBase64(fileObj, callback);
                /*if (typeof (FileReader) === 'undefined') {
                 this.directTurnIntoBase64(fileObj, callback);
                 } else {
                 /!*   try {
                 var reader = new FileReader();
                 reader.onload = function (e) {
                 var image = $('<img/>');
                 image.load(function () {
                 square = 120, //定义画布的大小，也就是图片压缩之后的像素
                 canvas = document.createElement('canvas'),
                 context = canvas.getContext('2d'),
                 imageWidth = 0, //压缩图片的大小
                 imageHeight = 0,
                 offsetX = 0,
                 offsetY = 0,
                 data = '';
                 canvas.width = square;
                 canvas.height = square;
                 context.clearRect(0, 0, square, square);
                 if (this.width > this.height) {
                 imageWidth = Math.round(square * this.width / this.height);
                 imageHeight = square;
                 offsetX = -Math.round((imageWidth - square) / 2);
                 } else {
                 imageHeight = Math.round(square * this.height / this.width);
                 imageWidth = square;
                 offsetY = -Math.round((imageHeight - square) / 2);
                 }
                 context.drawImage(this, offsetX, offsetY, imageWidth, imageHeight);
                 var data = canvas.toDataURL('image/jpeg');
                 callback(data);
                 });
                 image.attr('src', e.target.result);
                 };
                 reader.readAsDataURL(fileObj);
                 } catch (e) {
                 this.directTurnIntoBase64(fileObj, callback);
                 }*!/
                 }*/
            },
            directTurnIntoBase64: function (fileObj, callback) {
                var r = new FileReader();
                r.onload = function () {
                    this.imgBase64 = r.result;
                    callback(this.imgBase64);
                }
                r.readAsDataURL(fileObj);
            },
            //选择程序包-下一步
            packageNext: function () {
                $(this.checkPackagePage).css({"display": "none"});
                $(this.setProDesDialog).css({"display": "none"});
                $(this.setPackageXmlDesPage).css({"display": "block"});
                for (var key in toolsInfo) {
                    var key_ = key + "Con";
                    $(this[key_]).html("");
                    for (var i = 0; i < toolsInfo[key].length; i++) {

                        var node = CFactory.createNode({
                            type: "option",
                            attr: {
                                id: toolsInfo[key][i].id,
                                value: toolsInfo[key][i].id
                            },
                            text: toolsInfo[key][i].name
                        });
                        $(this[key_]).append(node);
                    }
                }
                var appInfo_ = this.packBageResult.data.appInfo;
                $(this.appNameCon).text(appInfo_.modelName);
                $(this.applicationTypeCon).val(appInfo_.applicationTypeCode);
                $(this.principleTypeCon).val(appInfo_.principleTypeCode);
                $(this.fmiVersionCon).val(appInfo_.fmiVersion);
                $(this.authorCon).val(appInfo_.author);
                $(this.categoryCon).val(appInfo_.categoryCode);
                $(this.generationToolCon).val(appInfo_.generatationTool);
                $(this.programTypeCon).val(appInfo_.programType);
                $(this.keywordCon).val(appInfo_.keyword);
                $(this.moduleCategoryCon).val(appInfo_.moduleCategoryCode);
            },
            //程序基本信息-上一步
            packageBack: function () {
                $(this.setPackageXmlDesPage).css({"display": "none"});
                $(this.setProDesDialog).css({"display": "none"});
                $(this.checkPackagePage).css({"display": "block"});
            },
            //打开程序简介页面
            openProFunDes: function () {
                $(this.checkPackagePage).css({"display": "none"});
                $(this.setPackageXmlDesPage).css({"display": "none"});
                $(this.setProDesDialog).css({"display": "block"});
                var appInfo_ = this.packBageResult.data.appInfo;
                $(this.setProDesNameCon).text(appInfo_.modelName);

            },
            //打开程序详情页面
            setProDesBack: function () {
                $(this.checkPackagePage).css({"display": "none"});
                $(this.setProDesDialog).css({"display": "none"});
                $(this.setPackageXmlDesPage).css({"display": "block"});
            },
            //添加功能特点
            appIntroduceAddFun: function () {
                var node = CFactory.createNode({
                    type: "div",
                    attr: {
                        style: "margin-top: 5px;"
                    },
                    child: [{
                        type: "span",
                        attr: {
                            style: "vertical-align: top;display: inline-block;width: 80px;text-align: left;float: left;color: #666;margin-right:5px;"
                        },
                        text: "特点："
                    },
                        {
                            type: "textarea",
                            attr: {
                                style: "padding: 5px 10px;color: #666;border: solid #ACA7A2 1px;",
                                rows: "1",
                                cols: "80",
                                class: "signAppFunText"
                            }
                        }]
                });
                $("#appIntCon").append(node);
            },
            //添加模块说明
            appIntroduceAddModuleDes: function () {
                var uuId = Math.uuid();
                var node = CFactory.createNode({
                    type: "div",
                    attr: {
                        style: "margin-top: 15px;"
                    },
                    child: [{
                        type: "span",
                        attr: {
                            style: "vertical-align: top;display: inline-block;width: 120px;text-align: left;float: left;color: #666;"
                        },
                        child: [{
                            type: "img",
                            attr: {
                                id: uuId + "Con",
                                uuId: uuId,
                                class: "signAppModuleImg",
                                src: "../../../imgs/add.png",
                                width: "80px",
                                height: "80px"
                            },
                            events: {
                                onclick: function () {
                                    var uuId = $(this).attr("uuId");
                                    document.getElementById(uuId).click();
                                }
                            }
                        }, {
                            type: "input",
                            attr: {
                                id: uuId,
                                type: "file",
                                name: "file",
                                accept: "image/png,image/jpg,image/jpeg",
                                style: "display:none"
                            },
                            events: {
                                onchange: function () {
                                    var id = $(this).attr("id");
                                    packBageProComponent.appIntroduceAddFunImg(this, id, id + 'Con')
                                }
                            }
                        }]
                    }, {
                        type: "div",
                        attr: {
                            style: "margin-left: 121px;"
                        },
                        child: [{
                            type: "div",
                            child: [{
                                type: "span",
                                attr: {
                                    style: "vertical-align: top;display: inline-block;width: 40px;text-align: left;color: #666;"
                                },
                                text: "标题："
                            }, {
                                type: "input",
                                attr: {
                                    style: "width: 87%;border: solid #ACA7A2 1px;padding: 5px 10px;",
                                    type: "text",
                                    class: "signAppModuleTitle"
                                }
                            }]
                        }, {
                            type: "div",
                            attr: {
                                style: "margin-top: 8px;"
                            },
                            child: [{
                                type: "span",
                                attr: {
                                    style: "vertical-align: top;display: inline-block;width: 40px;text-align: left;color: #666;"
                                },
                                text: "内容："
                            }, {
                                type: "textarea",
                                attr: {
                                    style: "padding: 5px 10px;color: #666;border: solid #ACA7A2 1px;",
                                    rows: "5",
                                    cols: "73",
                                    class: "signAppModuleText"
                                }
                            }]
                        }
                        ]
                    }]
                });
                $("#appIntModuleCon").append(node);
            },
            //小程序简介字符串
            ceatePreviewHtmlStr: function () {
                var signImgTransBase = $(".signImgTransBase");

                signImgTransBase.each(function (i, val) {
                    var img = new Image();
                    img.src = $(".signImgTransBase").eq(i).attr('src');
                    img.onload = function () {// 图片加载后执行的方法
                        var base64 = packBageProComponent.getBase64Image(img);// 将图片转成base64格式的方法
                        $(".signImgTransBase").eq(i).attr('src', base64); // 将原来的图片src改为base64格式的地址
                        if (i == $(".signImgTransBase").length - 1) {
                            window.htmlStrData = {
                                appInt: {
                                    appIntroduce: $(".signAppInitProject").val()
                                },
                                appFun: {
                                    funArry: [],
                                    imgs: []
                                }
                            };
                            var signAppFunTextEle = $(".signAppFunText");
                            signAppFunTextEle.each(function (i, val) {
                                var obj = {
                                    title: $(this).val(),
                                    content: $(this).val()
                                };
                                window.htmlStrData.appFun.funArry.push(obj)
                            });
                            var signAppFunImgsEle = $(".signAppFunImgs");
                            signAppFunImgsEle.each(function (i, val) {
                                var obj = {
                                    id: "",
                                    src: $(".signAppFunImgs").eq(i).attr("src")
                                };
                                window.htmlStrData.appFun.imgs.push(obj)
                            });




                            initHtmlDes(window.htmlStrData);
                            var str = $("#htmlStrDiv").html();

                            var dataPath = packBageProComponent.packBageResult.data.path;
							packBageProComponent.publishProgramToLocal();
                            //var res = Kworld.IoOption.createHtmlFile(dataPath, str, []);
                            //if (res) {
                              //  packBageProComponent.publishProgramToLocal();
                            //} else {
                              //  alert("小程序简介文件创建失败！")
                           // }

                        }
                    };
                });
            },
            //发布程序
            publishProgramToLocal: function () {
                var this_ = this;
                this.packBageResult.data.appInfo.applicationTypeCode = $(this.applicationTypeCon).val();
                this.packBageResult.data.appInfo.applicationType = $(this.applicationTypeCon).find("option:selected").text();
                this.packBageResult.data.appInfo.principleTypeCode = $(this.principleTypeCon).val();
                this.packBageResult.data.appInfo.principleType = $(this.principleTypeCon).find("option:selected").text();
                this.packBageResult.data.appInfo.fmiVersion = $(this.fmiVersionCon).val();
                this.packBageResult.data.appInfo.author = $(this.authorCon).val();
                this.packBageResult.data.appInfo.categoryCode = $(this.categoryCon).val();
                this.packBageResult.data.appInfo.category = $(this.categoryCon).find("option:selected").text();
                this.packBageResult.data.appInfo.generatationTool = $(this.generationToolCon).val();
                this.packBageResult.data.appInfo.programType = $(this.programTypeCon).val();
                this.packBageResult.data.appInfo.keyword = $(this.keywordCon).val();
                this.packBageResult.data.appInfo.moduleCategoryCode = $(this.moduleCategoryCon).val();
                this.packBageResult.data.appInfo.moduleCategory = $(this.moduleCategoryCon).find("option:selected").text();


                var guid = this.packBageResult.data.appInfo.guid;
                var modelName = this.packBageResult.data.appInfo.modelName;
                var categoryCode = this.packBageResult.data.appInfo.categoryCode;
                var moduleCategoryCode = this.packBageResult.data.appInfo.moduleCategoryCode;
                if (guid == null || modelName == null || categoryCode == null || moduleCategoryCode == null) {
                    alert("程序名、专业、guid、程序分类不能为空");
                    return;
                }
                var guidResult = Kworld.AppInfo.getByGuid(guid);
                var nameResult = Kworld.AppInfo.getByCategoryAndName(categoryCode, modelName);
                var dataPath = this.packBageResult.data.path;
                var appInfoStr = JSON.stringify(this.packBageResult.data.appInfo);


                if (guidResult != '' || nameResult != '') {
                    $.messager.defaults = {ok: "确认", cancel: "取消"};
                    $.messager.confirm("提示", "程序已存在，您确定要发布吗？", function (r) {
                        if (r) {
                            var publishResult = Kworld.IoOption.saveXMLAndPublish(dataPath, appInfoStr);
                            if (publishResult) {
                                alert("程序发布成功！");
                                window.close();
                            } else {
                                alert("程序发布失败！");
                            }
                        } else {
                            alert("返回修改");
                            window.close();
                        }

                    })
                } else {
                    var publishResult = Kworld.IoOption.saveXMLAndPublish(dataPath, appInfoStr);
                    if (publishResult) {
                        alert("程序发布成功！");
                        window.close();
                    } else {
                        alert("程序发布失败！");
                    }
                }


//           /* var publishResult=Kworld.IoOption.saveXMLAndPublish(this.packBageResult.data.path, JSON.stringify(this.packBageResult.data.appInfo));
//            if(publishResult){
//                alert("程序发布成功！");
//                window.close();
//            }else{
//                alert("程序发布失败！");
//            }*/
            },

            getBase64Image: function (img) {
                var canvas = document.createElement("canvas");// 创建一个canvas
                canvas.width = img.width; // 设置对应的宽高
                canvas.height = img.height;
                var ctx = canvas.getContext("2d"); // 二维绘图环境
                ctx.drawImage(img, 0, 0, img.width, img.height); // 将图片画在画布上
                var ext = img.src.substring(img.src.lastIndexOf(".") + 1).toLowerCase(); // 获取到图片的格式
                var dataURL = canvas.toDataURL("image/" + ext); // 得到base64 编码的 dataURL
                return dataURL;
            }
        });

    </script>
</body>
</html>